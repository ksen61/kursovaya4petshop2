{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block title %}–ê–¥–º–∏–Ω: –û—Ç—á–µ—Ç—ã –ø–æ –∑–∞–∫–∞–∑–∞–º{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'style/adminreports.css' %}" type="text/css"/>
{% endblock %}

{% block content %}
<div class="summary-header">
    <a href="{% url 'admin_reports' %}" class="back-link"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</a>
    <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</h1>
</div>

<div class="container-fluid py-4">
    <div class="card shadow mb-4">
        <div class="card-header">
            <h6 class="m-0 font-weight-bold">
                <i class="fas fa-filter me-2"></i>–§–∏–ª—å—Ç—Ä—ã –æ—Ç—á–µ—Ç–æ–≤
            </h6>
        </div>
        <div class="card-body">
            <form id="report-form" method="get">
                <div class="row g-4 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-chart-bar me-1"></i>–¢–∏–ø –æ—Ç—á–µ—Ç–∞
                        </label>
                        <select name="type" class="form-select" id="report-type">
                            <option value="day">üìÖ –ó–∞ –¥–µ–Ω—å</option>
                            <option value="week">üìÜ –ó–∞ –Ω–µ–¥–µ–ª—é</option>
                            <option value="month">üìä –ó–∞ –º–µ—Å—è—Ü</option>
                            <option value="filtered">üîç –° —Ñ–∏–ª—å—Ç—Ä–∞–º–∏</option>
                        </select>
                    </div>
        
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-calendar me-1"></i>–î–∞—Ç–∞
                        </label>
                        <input 
                            type="text" 
                            name="date" 
                            class="form-control" 
                            id="report-date" 
                            placeholder=""
                        >
                        <small id="date-help" class="text-muted"></small>
                    </div>
                    
        
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-box me-1"></i>–¢–æ–≤–∞—Ä
                        </label>
                        <select name="product_id" class="form-select" id="product-filter">
                            <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                            {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
        
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-tags me-1"></i>–ö–∞—Ç–µ–≥–æ—Ä–∏—è
                        </label>
                        <select name="category_id" class="form-select" id="category-filter">
                            <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
        
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-copyright me-1"></i>–ë—Ä–µ–Ω–¥
                        </label>
                        <select name="brand_id" class="form-select" id="brand-filter">
                            <option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option>
                            {% for brand in brands %}
                                <option value="{{ brand.id }}">{{ brand.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
        
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-user me-1"></i>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                        </label>
                        <select name="user_id" class="form-select" id="user-filter">
                            <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                            {% for user in users %}
                                <option value="{{ user.id }}">{{ user.first_name }} {{ user.last_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
        
                <div class="d-flex justify-content-end mt-4 gap-3">
                    <button type="button" id="show-btn" class="btn btn-primary">
                        <i class="fas fa-chart-bar me-2"></i>–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
                    </button>
                    <button type="button" id="export-btn" class="btn btn-outline-secondary">
                        <i class="fas fa-download me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç CSV
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold">
                <i class="fas fa-table me-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—á—ë—Ç–∞
            </h6>
            <span class="badge bg-primary" id="records-count">
                <i class="fas fa-database me-1"></i>0 –∑–∞–ø–∏—Å–µ–π
            </span>
        </div>
        <div class="card-body">
            <div id="loading-spinner" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <p class="text-muted mt-3">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>
            <div id="results-container">
                <div class="text-center py-5">
                    <i class="fas fa-chart-pie fa-4x text-gray-300 mb-4"></i>
                    <h5 class="text-muted mb-2">–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</h5>
                    <p class="text-muted">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<script>
    $(document).ready(function() {
        const API_URL = '{% url "api_orders_report" %}';
        let dataTable = null;
    
        function getFormParams(exportFlag = false) {
            const params = new URLSearchParams();
            params.append('type', $('#report-type').val());
            params.append('date', $('#report-date').val());
            
            const productId = $('#product-filter').val();
            const categoryId = $('#category-filter').val();
            const brandId = $('#brand-filter').val();
            const userId = $('#user-filter').val();
            
            if (productId) params.append('product_id', productId);
            if (categoryId) params.append('category_id', categoryId);
            if (brandId) params.append('brand_id', brandId);
            if (userId) params.append('user_id', userId);
            
            if (exportFlag) {
                params.append('export', 'csv');
            }
            
            return params;
        }
    
        function loadData(exportMode = false) {
            const params = getFormParams(exportMode);
            
            if (exportMode) {
                window.location.href = API_URL + '?' + params.toString();
                return;
            }
    
            $('#loading-spinner').show();
            $('#results-container').hide();
    
            fetch(API_URL + '?' + params.toString())
                .then(response => {
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                    return response.json();
                })
                .then(responseData => {
                    displayData(responseData.data, responseData.columns, responseData.report_type);
                    $('#records-count').html(`<i class="fas fa-database me-1"></i>${responseData.total_count} –∑–∞–ø–∏—Å–µ–π`);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    $('#results-container').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö
                        </div>
                    `).show();
                })
                .finally(() => {
                    $('#loading-spinner').hide();
                    $('#results-container').show();
                });
        }
    
        function displayData(data, columns, reportType) {
            if (!data || data.length === 0) {
                $('#results-container').html(`
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-4x text-gray-300 mb-4"></i>
                        <h5 class="text-muted mb-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h5>
                        <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤</p>
                    </div>
                `);
                return;
            }
    
            const headers = Object.keys(columns);
            const columnNames = columns;
            const reportTypeName = getReportTypeName(reportType);
    
            let tableHTML = `
                <div class="alert alert-info mb-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-chart-bar fa-lg me-3"></i>
                        <div>
                            <strong class="d-block">–¢–∏–ø –æ—Ç—á–µ—Ç–∞: ${reportTypeName}</strong>
                            <small class="d-block mt-1">–ö–æ–ª–æ–Ω–æ–∫: ${headers.length} | –ó–∞–ø–∏—Å–µ–π: ${data.length}</small>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-striped" id="dataTable">
                        <thead>
                            <tr>
                                ${headers.map(col => 
                                    `<th class="text-nowrap">${columnNames[col]}</th>`
                                ).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(row => `
                                <tr>
                                    ${headers.map(col => 
                                        `<td>${row[col] || '<span class="text-muted">-</span>'}</td>`
                                    ).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
    
            $('#results-container').html(tableHTML);
    
            if ($.fn.DataTable && $('#dataTable').length) {
                if (dataTable) {
                    dataTable.destroy();
                }
                dataTable = $('#dataTable').DataTable({
                    "pageLength": 25,
                    "language": {
                        "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Russian.json"
                    },
                    "order": [[0, "asc"]],
                    "responsive": true,
                    "autoWidth": false,
                    "dom": '<"top"<"d-flex justify-content-between align-items-center"flp>>rt<"bottom"<"d-flex justify-content-between align-items-center"ip>><"clear">'
                });
            }
        }
    
        function getReportTypeName(reportType) {
            const types = {
                'day': '–ó–∞ –¥–µ–Ω—å',
                'week': '–ó–∞ –Ω–µ–¥–µ–ª—é', 
                'month': '–ó–∞ –º–µ—Å—è—Ü',
                'filtered': '–° —Ñ–∏–ª—å—Ç—Ä–∞–º–∏'
            };
            return types[reportType] || reportType;
        }
    
        $('#show-btn').on('click', function() {
            $(this).html('<i class="fas fa-spinner fa-spin me-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞...');
            loadData(false);
            setTimeout(() => {
                $(this).html('<i class="fas fa-chart-bar me-2"></i>–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç');
            }, 1000);
        });
    
        $('#export-btn').on('click', function() {
            loadData(true);
        });
    
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.toString()) {
            $('#report-type').val(urlParams.get('type') || 'day');
            $('#report-date').val(urlParams.get('date') || '');
            $('#product-filter').val(urlParams.get('product_id') || '');
            $('#category-filter').val(urlParams.get('category_id') || '');
            $('#brand-filter').val(urlParams.get('brand_id') || '');
            $('#user-filter').val(urlParams.get('user_id') || '');
            
            setTimeout(() => loadData(false), 500);
        }
    
        $('#report-type').on('change', function() {
            if ($('#report-date').val()) {
                setTimeout(() => loadData(false), 300);
            }
        });
    });
    document.addEventListener('DOMContentLoaded', function() {
        const dateFormat = "{{ request.user.profile.date_format|default:'%Y.%m.%d'|escapejs }}";
        const dateInput = document.getElementById('report-date');
        const dateHelp = document.getElementById('date-help');
        const showBtn = document.getElementById('show-btn');
    
        let placeholder = '';
        let regexPattern;
    
        switch(dateFormat) {
            case '%d.%m.%Y':
                placeholder = '–î–î.–ú–ú.–ì–ì–ì–ì';
                regexPattern = /^\d{2}\.\d{2}\.\d{4}$/;
                break;
            case '%Y.%m.%d':
                placeholder = '–ì–ì–ì–ì.–ú–ú.–î–î';
                regexPattern = /^\d{4}\.\d{2}\.\d{2}$/;
                break;
            case '%m/%d/%Y':
                placeholder = '–ú–ú/–î–î/–ì–ì–ì–ì';
                regexPattern = /^\d{2}\/\d{2}\/\d{4}$/;
                break;
            default:
                placeholder = '–î–î.–ú–ú.–ì–ì–ì–ì';
                regexPattern = /^\d{2}\.\d{2}\.\–¥{4}$/;
        }
    
        dateInput.placeholder = placeholder;
        dateHelp.textContent = `–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: ${placeholder}`;
    
        dateInput.addEventListener('input', function() {
            const val = this.value.trim();
            if (val === '') {
                this.classList.remove('is-invalid', 'is-valid');
                return;
            }
            if (!regexPattern.test(val)) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else {
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
            }
        });
    
        showBtn.addEventListener('click', function(e) {
            const val = dateInput.value.trim();
            if (val && !regexPattern.test(val)) {
                e.preventDefault();
                alert(`–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ: ${placeholder}`);
                dateInput.focus();
                return;
            }
        
            if (val) {
                let parts;
                let inputDate;
                switch(dateFormat) {
                    case '%d.%m.%Y':
                        parts = val.split('.');
                        inputDate = new Date(parts[2], parts[1]-1, parts[0]);
                        break;
                    case '%Y.%m.%d':
                        parts = val.split('.');
                        inputDate = new Date(parts[0], parts[1]-1, parts[2]);
                        break;
                    case '%m/%d/%Y':
                        parts = val.split('/');
                        inputDate = new Date(parts[2], parts[0]-1, parts[1]);
                        break;
                    default:
                        parts = val.split('.');
                        inputDate = new Date(parts[2], parts[1]-1, parts[0]);
                }
        
                const today = new Date();
                today.setHours(0,0,0,0);
                if (inputDate > today) {
                    e.preventDefault();
                    alert('–î–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º!');
                    dateInput.focus();
                    return;
                }
            }
        
            $(this).html('<i class="fas fa-spinner fa-spin me-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞...');
            loadData(false);
            setTimeout(() => {
                $(this).html('<i class="fas fa-chart-bar me-2"></i>–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç');
            }, 1000);
        });
        
    });
    
</script>
{% endblock %}