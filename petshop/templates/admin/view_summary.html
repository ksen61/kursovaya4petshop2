{% extends "base.html" %}
{% load static %}

{% load custom_tags %}

{% block title %}–ê–¥–º–∏–Ω: –°–≤–æ–¥–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'style/viewsummary.css' %}" type="text/css"/>
{% endblock %}

{% block content %}
<div class="summary-header">
    <a href="{% url 'admin_reports' %}" class="back-link"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</a>
    <h1 id="pageTitle">–°–≤–æ–¥–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã</h1>
</div>

<div class="table-controls">
    <button onclick="loadTableData('categories')" id="btnCategories" class="active">üìä –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</button>
    <button onclick="loadTableData('months')" id="btnMonths">üìÖ –ü–æ –º–µ—Å—è—Ü–∞–º</button>
    <button onclick="loadTableData('brands')" id="btnBrands">üè∑Ô∏è –ü–æ –±—Ä–µ–Ω–¥–∞–º</button>
</div>

<div class="loading" id="loading">
    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
</div>

<div id="tableContent" style="display: none;">
    <div class="stats-summary" id="statsSummary">
    </div>
    <table id="summaryTable" class="summaryTable">
        <thead id="tableHeader" class="tableHeader">
        </thead>
        <tbody id="tableBody" class="tableBody">
        </tbody>
    </table>
</div>

<div id="errorMessage" class="error-message" style="display: none;">
    <i class="fas fa-exclamation-triangle"></i> <span id="errorText"></span>
</div>

<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script>
let userDateFormat = "%d.%m.%Y";

async function loadUserSettings() {
    try {
        const res = await fetch('/api/profile/');
        if(res.ok){
            const data = await res.json();
            if(data.date_format) userDateFormat = data.date_format;
        }
    } catch(err){
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
    }
}

function formatDateByPattern(date, format){
    if(!date) return '';
    const d = dayjs(date);
    switch(format){
        case "%Y.%m.%d": return d.format("YYYY.MM.DD");
        case "%m/%d/%Y": return d.format("MM/DD/YYYY");
        default: return d.format("DD.MM.YYYY");
    }
}

async function loadTableData(tableType) {
    try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('tableContent').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';

        document.querySelectorAll('.table-controls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn' + tableType.charAt(0).toUpperCase() + tableType.slice(1)).classList.add('active');

        await loadUserSettings();

        const response = await fetch(`/api/summary-tables/?type=${tableType}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                {% if user.is_authenticated %}
                'X-CSRFToken': '{{ csrf_token }}'
                {% endif %}
            }
        });

        const data = await response.json();
        if(!response.ok || !data.success) throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');

        renderTable(data);

    } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
    }
}

function renderTable(data) {
    document.getElementById('pageTitle').textContent = data.title;

    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    const statsSummary = document.getElementById('statsSummary');

    tableHeader.innerHTML = '';
    tableBody.innerHTML = '';

    const headerRow = document.createElement('tr');
    data.fields.forEach(field => {
        const th = document.createElement('th');
        th.textContent = data.column_names[field];
        headerRow.appendChild(th);
    });
    tableHeader.appendChild(headerRow);

    let totalOrders = 0;
    let totalSales = 0;

    data.data.forEach(row => {
        const tr = document.createElement('tr');
        data.fields.forEach(field => {
            const td = document.createElement('td');
            let value = row[field];
    
            if(field === 'month'){ 
                value = formatDateByPattern(value + '-01', userDateFormat);
            }
    
            else if (field === 'total_sales' && typeof value === 'number') {
                value = value.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' ‚ÇΩ';
                totalSales += row[field];
            } else if (field === 'avg_order_value' && typeof value === 'number') {
                value = value.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' ‚ÇΩ';
            } else if (field === 'total_orders' && typeof value === 'number') {
                totalOrders += value;
            }
    
            td.textContent = value;
            tr.appendChild(td);
        });
        tableBody.appendChild(tr);
    });
    

    if (totalOrders > 0 || totalSales > 0) {
        statsSummary.innerHTML = `<strong>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> ${totalOrders.toLocaleString('ru-RU')} –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å—É–º–º—É ${totalSales.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2})} ‚ÇΩ`;
    } else {
        statsSummary.innerHTML = '';
    }

    document.getElementById('loading').style.display = 'none';
    document.getElementById('tableContent').style.display = 'block';
}

function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
}

document.addEventListener('DOMContentLoaded', function() {
    loadTableData('categories');
});
</script>

{% endblock %}